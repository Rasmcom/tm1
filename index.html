<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ملف شواهد الأداء الوظيفي للمعلم</title>
    <!-- الخطوط والأيقونات والستايل كما هو في كودك الأصلي -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... جميع الستايلات كما هي في كودك الأصلي ... */
    </style>
    <!-- Firebase مكتبات -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- باقي الصفحة كما هو في كودك الأصلي -->
    <!-- ... جميع عناصر الصفحة (الهيدر، التبويبات، النماذج ...) ... -->

    <script>
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD6P2Y2.................", // أضف مفتاح API الخاص بك هنا (من إعدادات مشروع Firebase)
            authDomain: "testm2-6ffa1.firebaseapp.com",
            projectId: "testm2-6ffa1",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const teacherId = "testm2-6ffa1";
        const teacherRef = db.collection("teachers").doc(teacherId);

        // دوال عامة للحفظ والاسترجاع
        async function saveField(field, data) {
            await teacherRef.set({ [field]: data }, { merge: true });
        }
        async function getField(field) {
            const doc = await teacherRef.get();
            return doc.exists && doc.data()[field] ? doc.data()[field] : null;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // البيانات الأساسية
            document.getElementById('saveBasicInfo').addEventListener('click', async function() {
                const teacherData = {
                    name: document.getElementById('teacherName').value,
                    department: document.getElementById('educationDept').value,
                    school: document.getElementById('schoolName').value,
                    year: document.getElementById('academicYear').value
                };
                await saveField('teacherData', teacherData);
                updateTeacherInfo(teacherData);
                alert('تم حفظ البيانات بنجاح في قاعدة البيانات!');
            });
            // استرجاع بيانات المعلم عند تحميل الصفحة
            const teacherData = await getField('teacherData') || {};
            updateTeacherInfo(teacherData);
            document.getElementById('teacherName').value = teacherData.name || '';
            document.getElementById('educationDept').value = teacherData.department || '';
            document.getElementById('schoolName').value = teacherData.school || '';
            document.getElementById('academicYear').value = teacherData.year || '';

            function updateTeacherInfo(data) {
                const teacherInfoHeader = document.getElementById('teacherInfoHeader');
                const headerTeacherName = document.getElementById('headerTeacherName');
                headerTeacherName.textContent = data.name ? " " + data.name : '';
                teacherInfoHeader.innerHTML = (data.name || data.department || data.school || data.year) ?
                    `<p><strong>المعلم:</strong> ${data.name || 'غير محدد'}</p>
                     <p><strong>الإدارة:</strong> ${data.department || 'غير محدد'}</p>
                     <p><strong>المدرسة:</strong> ${data.school || 'غير محدد'}</p>
                     <p><strong>العام الدراسي:</strong> ${data.year || 'غير محدد'}</p>` :
                    '<p>لم يتم إدخال البيانات بعد</p>';
            }

            // المقدمة والرؤية والرسالة والقيم
            async function loadIntroduction() {
                const introData = await getField('introductionData') || {};
                document.getElementById('vision').value = introData.vision || '';
                document.getElementById('mission').value = introData.mission || '';
                document.getElementById('values').value = introData.values || '';
                document.getElementById('generalIntro').value = introData.generalIntro || '';
            }
            document.getElementById('saveIntroduction')?.addEventListener('click', async function() {
                const introData = {
                    vision: document.getElementById('vision').value,
                    mission: document.getElementById('mission').value,
                    values: document.getElementById('values').value,
                    generalIntro: document.getElementById('generalIntro').value
                };
                await saveField('introductionData', introData);
                alert('تم حفظ المقدمة بنجاح!');
            });
            await loadIntroduction();

            // السيرة الذاتية
            document.getElementById('saveCV').addEventListener('click', async function() {
                const cvData = {
                    fullName: document.getElementById('fullName').value,
                    specialization: document.getElementById('specialization').value,
                    qualification: document.getElementById('qualification').value,
                    graduationYear: document.getElementById('graduationYear').value,
                    yearsOfExperience: document.getElementById('yearsOfExperience').value
                };
                await saveField('cvData', cvData);
                alert('تم حفظ السيرة الذاتية بنجاح!');
            });
            const cvData = await getField('cvData') || {};
            document.getElementById('fullName').value = cvData.fullName || '';
            document.getElementById('specialization').value = cvData.specialization || '';
            document.getElementById('qualification').value = cvData.qualification || '';
            document.getElementById('graduationYear').value = cvData.graduationYear || '';
            document.getElementById('yearsOfExperience').value = cvData.yearsOfExperience || '';

            // بيانات المتابعة
            document.getElementById('saveFollowup').addEventListener('click', async function() {
                const followupData = {
                    firstDate: document.getElementById('firstFollowupDate').value,
                    firstNotes: document.getElementById('firstFollowupNotes').value,
                    firstName: document.getElementById('firstFollowupName').value,
                    secondDate: document.getElementById('secondFollowupDate').value,
                    secondNotes: document.getElementById('secondFollowupNotes').value,
                    secondName: document.getElementById('secondFollowupName').value,
                    recommendations: document.getElementById('recommendations').value
                };
                await saveField('followupData', followupData);
                alert('تم حفظ بيانات المتابعة بنجاح!');
            });
            const followupData = await getField('followupData') || {};
            document.getElementById('firstFollowupDate').value = followupData.firstDate || '';
            document.getElementById('firstFollowupNotes').value = followupData.firstNotes || '';
            document.getElementById('firstFollowupName').value = followupData.firstName || '';
            document.getElementById('secondFollowupDate').value = followupData.secondDate || '';
            document.getElementById('secondFollowupNotes').value = followupData.secondNotes || '';
            document.getElementById('secondFollowupName').value = followupData.secondName || '';
            document.getElementById('recommendations').value = followupData.recommendations || '';

            // خطة التحسين
            function getImprovementItems() {
                const improvements = [];
                document.querySelectorAll('.improvement-item').forEach(item => {
                    const area = item.querySelector('.improvement-area').textContent;
                    const priority = item.querySelector('.improvement-priority').textContent;
                    const goalText = item.querySelector('p:nth-child(2)').textContent;
                    const actionsText = item.querySelector('p:nth-child(3)').textContent;
                    const periodText = item.querySelector('p:nth-child(4)').textContent;
                    improvements.push({
                        area,
                        priority,
                        goal: goalText.replace('الهدف:', '').trim(),
                        actions: actionsText.replace('الإجراءات:', '').trim(),
                        period: periodText.replace('الفترة:', '').trim()
                    });
                });
                return improvements;
            }
            async function saveImprovements() {
                const improvements = getImprovementItems();
                await saveField('improvements', improvements);
                alert('تم حفظ خطط التحسين بنجاح!');
            }
            document.getElementById('addImprovementBtn').addEventListener('click', saveImprovements);
            // استرجاع الخطط في بداية الصفحة
            const improvements = await getField('improvements') || [];
            // ... أنشئ العناصر في الصفحة بنفس الطريقة الأصلية

            // الدورات التدريبية
            async function saveCourses() {
                const courses = [];
                document.querySelectorAll('.course-item').forEach(item => {
                    courses.push({
                        name: item.querySelector('.course-name')?.value || '',
                        date: item.querySelector('.course-date')?.value || '',
                        hours: item.querySelector('.course-hours')?.value || ''
                    });
                });
                await saveField('courses', courses);
                alert('تم حفظ الدورات التدريبية بنجاح!');
            }
            // ... استدعِ saveCourses بعد كل إضافة أو تعديل دورة تدريبية
            const courses = await getField('courses') || [];
            // ... أنشئ عناصر الدورات في الصفحة بنفس الطريقة الأصلية

            // الشهادات
            async function saveCertificates() {
                const certificates = [];
                document.querySelectorAll('.certificate-item').forEach((item, idx) => {
                    const img = item.querySelector('.certificate-preview').src;
                    certificates.push({ type: 'image', data: img });
                });
                await saveField('certificates', certificates);
                alert('تم حفظ الشهادات بنجاح!');
            }
            // ... استدعِ saveCertificates بعد كل رفع شهادة
            const certificates = await getField('certificates') || [];
            // ... أنشئ عناصر الشهادات في الصفحة بنفس الطريقة الأصلية

            // شواهد الأداء (التقييمات والملاحظات)
            async function savePerformanceRatings() {
                const ratings = {};
                document.querySelectorAll('.rating-slider').forEach(slider => {
                    ratings[slider.dataset.id] = slider.value;
                });
                await saveField('performanceRatings', ratings);
            }
            async function savePerformanceNotes() {
                const notes = {};
                document.querySelectorAll('.performance-note').forEach(note => {
                    notes[note.dataset.id] = note.value;
                });
                await saveField('performanceNotes', notes);
            }
            // ... استدعِ دوال الحفظ بعد كل تغيير في التقييم أو الملاحظات
            const performanceRatings = await getField('performanceRatings') || {};
            const performanceNotes = await getField('performanceNotes') || {};
            // ... عبئ القيم في الصفحة كما في الكود الأصلي

            // باقي الأكواد الخاصة بالتنقل والصفحة كما هي بدون تغيير (لا تحتاج تعديل)

            // ملاحظة: يجب وضع مفتاح `apiKey` الصحيح الخاص بك في firebaseConfig ليعمل الربط!
        });
    </script>
</body>
</html>
